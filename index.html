<html>
 <head>
  <title>HTML Pad Preview</title>
  <link rel="stylesheet" href="style.css" type="text/css"/>
  <script type="text/javascript" src="jquery-1.10.2.js"></script>
 </head>
 <body>
  <p id="head">
   <span id="title"><a href=".">HTML Pad Preview</a></span>
   <span id="source"></span>
   <input type="text" style="width:300px;" id="url" onchange="updateUrl();" value=""></input>
   <input type="button" onclick="loadPad();" value="Refresh"></input>
   <span>Clean raw HTML:</span>
   <input type="text" onclick="this.select();" value="" id="copy" />
   <span id="code"><a href="https://github.com/regardscitoyens/HTML-pad-preview">code</a></span>
  </p>
  <div id="preview"></div>
 </body>
 <script type="text/javascript">
var updateUrl = function(){
 window.location.hash = "#" + $("#url").val();
},  loadPad = function(){
 var padUrl = window.location.hash.substring(1),
     htmlUrl = padUrl + "/export/html",
     colors = ['FD7', 'FBB', 'ADF', 'BFF', 'DBF', 'BFB'],
     commentW = (window.innerWidth - $('body').innerWidth())/2;
  if (!$("#url").attr("value"))
   $("#url").attr("value", padUrl);
  if (!padUrl) {
   htmlUrl = "./homepad-export.html";
   $("#source").html('Source pad:');
  } else {
   if (padUrl.search("/p/") == -1)
    htmlUrl = padUrl.replace(/\/([^\/]*)$/, "/ep/pad/export/$1/latest?format=html");
   $("#source").html('<a target="_blank" href="'+padUrl+'">Source pad:</a>');
  }
  $.get(
   htmlUrl,
   function(data){
    data = data.replace(/\n/g, "")
     .replace(/^.*<body>/, "")
     .replace(/<\/body>.*$/, "")
     .replace(/(&nbsp;|\s)+/g, " ")
     .replace(/(<br>|\s)*<em>([^<]+)<\/em>(<br>|\s)*/g, '&lt;sup class="note"&gt;*&lt;/sup&gt;&lt;em class="comment"&gt;$2&lt;/em&gt; ')
     .replace(/(p|div|h\d+|sup|em)&gt;(<br>|\s)*&lt;(p|div|h\d+|sup|em)/g, "$1&gt;&lt;$3")
     .replace(/<br>/g, "&lt;br/&gt;")
     .replace(/<[^>]*>/g, "")
     .replace(/&lt;/g, "<")
     .replace(/&gt;/g, ">")
     .replace(/&#x2F;/g, "/")
     .replace(/&quot;/g, '"')
     .replace(/&amp;/g, "&");
    $("#preview").html(data);
    $("#copy").attr(
     "value",
     $("#preview").html()
      .replace(/<sup class="note">\*<\/sup><em class="comment"[^>]*>.*?<\/em>/g, '')
      .trim()
    );
    $(".comment").map(function(i,c){
     var col = "#" + colors[i % colors.length];
     $(c).attr(
      "style",
      "position: absolute;" +
      (i % 2 == 0 ? "righ" : "lef")+"t: "+Math.floor(0.1*commentW)+";" +
      "display: inline;" +
      "background-color: "+col+";" +
      "border-radius: 8px;" +
      "padding: 5px;" +
      "font-size: 16px;" +
      "font-weight: normal;" +
      "width: "+Math.floor(0.8*commentW)+"px;" +
      "z-index: -1;"
     ).prev().css("background-color", col);
    });
   },
   "html"
  ).fail(function(){
   $("#url").val("");
   updateUrl();
  });
};
$(document).ready(function(){
 loadPad();
 setInterval(loadPad, 15000);
 $(window).on('hashchange', function(){
  $("#url").val(window.location.hash.substring(1));
  loadPad();
 });
});
 </script>
</html>
